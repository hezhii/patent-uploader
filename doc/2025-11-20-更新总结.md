# 2025-11-20 更新总结

## 完成的功能

### 1. ✅ 支持仅导入有效发明专利选项

**需求**: 专利上传接口 `/admin/patent/import` 支持查询参数 `onlyValidInvention` 控制是否仅导入有效发明专利。

**实现内容**:

#### 前端改进
1. **Store 配置** (`src/stores/index.ts`)
   - 在 `settings` 中添加 `onlyValidInvention: false` 配置项
   - 自动保存到 localStorage

2. **UI 组件** (`src/components/FileUpload.vue`)
   - 在上传区域添加 checkbox 控件
   - 样式：蓝色选中状态，带文字标签"仅导入有效发明专利"
   - 上传时禁用，避免中途修改

3. **上传逻辑** (`src/composables/useFileUpload.ts`)
   - 添加 `onlyValidInvention` 响应式变量
   - 添加 `setOnlyValidInvention()` 方法
   - 在调用 Rust 命令时传递该参数

#### 后端改进
1. **Rust 命令** (`src-tauri/src/commands/upload.rs`)
   - `upload_file` 函数接收 `only_valid_invention: bool` 参数
   - 构建 URL 时添加查询参数：`?onlyValidInvention=true/false`
   - 记录日志显示该参数值

**使用方式**:
1. 在文件上传页面，勾选"仅导入有效发明专利"复选框
2. 点击"开始上传"
3. 系统会将该配置保存，并在上传时传递给服务器
4. 服务器根据参数决定是否过滤非有效发明专利

---

### 2. ✅ 修复 Ubuntu 24 输入框卡死问题

**问题描述**: 
- Dev 模式运行正常
- Build 后在 Ubuntu 24 运行，服务器配置输入框输入时应用卡死
- 设置 `GTK_IM_MODULE=ibus WEBKIT_DISABLE_COMPOSITING_MODE=1` 无效

**问题分析**:
这是 Tauri/WebView 在 Linux 平台的已知问题，主要原因：
1. IBus/Fcitx 输入法框架与 WebView 的交互冲突
2. WebKit 合成模式在某些环境下不稳定
3. X11/Wayland 显示服务器兼容性问题

**解决方案**:

#### 1. 创建启动脚本 (`patentupload.sh`)
```bash
#!/bin/bash
export GTK_IM_MODULE=xim          # 使用简单输入法模块
export QT_IM_MODULE=xim           # 避免复杂输入法交互
export XMODIFIERS=@im=none        # 禁用 X 输入法扩展
export WEBKIT_DISABLE_COMPOSITING_MODE=1  # 禁用 WebKit 合成模式
```

**为什么之前的方案不工作**:
- `GTK_IM_MODULE=ibus` 反而会启用 IBus，应该设置为 `xim`
- 需要同时设置多个环境变量才能完全避免冲突

#### 2. 优化 Tauri 配置 (`src-tauri/tauri.conf.json`)
```json
{
  "app": {
    "windows": [{
      "webviewOptions": {
        "windowEffects": {
          "linux": {
            "disableAutomaticWindowTabbing": true
          }
        }
      }
    }],
    "withGlobalTauri": true
  }
}
```

#### 3. 创建详细文档 (`doc/Ubuntu输入框卡死问题解决方案.md`)
包含：
- 问题原因详解
- 4 种解决方案（启动脚本、手动设置、Desktop 文件、故障排除）
- 验证步骤
- 相关链接

**使用方式**:
```bash
# 首次使用添加执行权限
chmod +x patentupload.sh

# 使用脚本启动应用
./patentupload.sh
```

---

## 修改的文件列表

### 前端文件
- ✅ `src/stores/index.ts` - 添加 onlyValidInvention 配置
- ✅ `src/components/FileUpload.vue` - 添加 checkbox UI 和逻辑
- ✅ `src/composables/useFileUpload.ts` - 传递参数到后端

### 后端文件
- ✅ `src-tauri/src/commands/upload.rs` - 支持查询参数
- ✅ `src-tauri/tauri.conf.json` - Linux WebView 优化

### 新增文件
- ✅ `patentupload.sh` - Linux 启动脚本
- ✅ `doc/Ubuntu输入框卡死问题解决方案.md` - 详细文档

### 文档更新
- ✅ `README.md` - 添加功能说明和 Linux 使用指南
- ✅ `CHANGELOG.md` - 记录本次更新

---

## 测试建议

### 功能测试
1. **onlyValidInvention 选项**
   - [ ] 勾选 checkbox，上传文件，检查服务器日志确认参数传递
   - [ ] 不勾选，上传文件，确认默认行为
   - [ ] 配置持久化：关闭应用重新打开，确认选项状态保持

2. **Ubuntu 输入框修复**
   - [ ] 在 Ubuntu 24 构建应用：`pnpm tauri build`
   - [ ] 使用启动脚本运行：`./patentupload.sh`
   - [ ] 测试服务器配置输入框：输入 URL、用户名、密码
   - [ ] 测试中文输入法切换
   - [ ] 测试其他输入框（如日志搜索等）

### 回归测试
- [ ] 文件扫描功能正常
- [ ] 登录认证正常
- [ ] 文件上传进度正常
- [ ] 日志记录正常

---

## 后续建议

1. **Windows/macOS 测试**
   - 确认新功能在其他平台正常工作
   - 启动脚本仅用于 Linux

2. **服务器接口确认**
   - 确认服务器端正确处理 `onlyValidInvention` 查询参数
   - 测试 true/false 两种情况的业务逻辑

3. **用户体验优化**
   - 考虑添加 tooltip 解释"仅导入有效发明专利"的含义
   - 在日志中显示该选项的状态

4. **Linux 打包优化**
   - 考虑在 .deb 包的 desktop 文件中直接包含环境变量设置
   - 或提供安装后脚本自动配置
