# 2025-11-21 跳过列转换功能更新

## 更新概述

添加了在命令行工具和图形界面中跳过 Excel 列转换，直接上传原始文件的功能。

## 功能说明

### 1. 命令行工具 (patent-cli)

#### 新特性
- **自动检测列映射配置**：如果没有通过 `--column-mapping` 参数指定列映射，工具将跳过文件转换步骤
- **直接上传原始文件**：在跳过转换的情况下，直接读取并上传输入目录中的原始 Excel 文件
- **简化参数要求**：当不需要转换时，`--output` 参数将被忽略（仍需提供，但不会使用）

#### 使用示例

**不带列映射（直接上传）：**
```bash
./patent-cli \
  --server http://localhost:3000 \
  --username admin \
  --password admin123 \
  --input /path/to/excel/files \
  --output /tmp/unused
```

**带列映射（转换后上传）：**
```bash
./patent-cli \
  --server http://localhost:3000 \
  --username admin \
  --password admin123 \
  --input /path/to/excel/files \
  --output /path/to/converted/files \
  --column-mapping "申请号:申请号" \
  --column-mapping "名称:专利名称"
```

#### 执行流程变化

**之前的流程：**
1. 登录获取 token
2. 扫描输入目录
3. **必须转换所有文件**
4. 上传转换后的文件

**现在的流程：**
1. 登录获取 token
2. 扫描输入目录
3. **条件处理：**
   - 如果有列映射配置：转换文件 → 上传转换后的文件
   - 如果无列映射配置：跳过转换 → 直接上传原文件
4. 显示上传结果

### 2. 图形界面工具 (GUI)

#### 新特性
- **可选的列映射步骤**：在步骤2中明确标注"列名映射配置（可选）"
- **跳过按钮**：添加"跳过列映射，直接处理文件"按钮，允许用户快速跳过配置
- **智能界面调整**：
  - 未配置列映射时，不显示"目标文件夹"选择框
  - 显示提示信息说明将直接上传原始文件
  - 按钮文字自动调整（"开始转换" / "准备上传"）

#### 用户操作流程

**场景1：需要列转换**
1. 配置服务器连接
2. 配置列映射关系
3. 选择源文件夹和目标文件夹
4. 扫描并转换文件
5. 上传转换后的文件

**场景2：不需要列转换**
1. 配置服务器连接
2. 点击"跳过列映射，直接处理文件"按钮
3. 只选择源文件夹（无需选择目标文件夹）
4. 扫描文件
5. 直接上传原始文件

## 代码修改说明

### 1. CLI 工具 (`src-tauri/src/bin/patent-cli.rs`)

修改了步骤3的逻辑：

```rust
// 步骤 3: 转换文件（如果需要）
let files_to_upload = if !args.column_mappings.is_empty() {
    println!("[3/4] 正在转换文件...");
    // ... 执行转换
    converted_files
} else {
    println!("[3/4] 跳过文件转换（未配置列映射）...");
    println!("✓ 将直接上传原始文件");
    // 直接使用扫描到的原文件
    scan_result.files.clone()
};
```

### 2. 图形界面主组件 (`src/App.vue`)

- 修改步骤2标题为"列名映射配置（可选）"
- 添加提示信息和"跳过列映射"按钮
- 添加 `handleSkipMapping()` 函数清空列映射配置

### 3. 文件操作组件 (`src/components/FileOperations.vue`)

- 添加 `needsConversion` 计算属性判断是否需要转换
- 条件显示目标文件夹选择框
- 显示不同的提示信息和按钮文字

### 4. 文件操作 Composable (`src/composables/useFileOperations.ts`)

- 修改 `canConvert` 逻辑，允许没有目标路径时也能处理
- 修改 `startConversion()` 函数：
  - 检测列映射数量
  - 如果为空，直接返回扫描到的原始文件（不调用转换命令）
  - 如果有列映射，执行原有的转换逻辑

## 优势

1. **灵活性提升**：用户可以根据实际需求选择是否进行列转换
2. **效率提高**：不需要转换时节省了文件转换的时间
3. **简化操作**：减少了必须配置的步骤
4. **向后兼容**：保留了原有的列转换功能，不影响现有用户

## 测试建议

### CLI 工具测试

1. **测试不带列映射的上传**：
```bash
./patent-cli -s <server> -u <user> -p <pass> -i <input> -o /tmp
```

2. **测试带列映射的上传**：
```bash
./patent-cli -s <server> -u <user> -p <pass> -i <input> -o <output> -m "列1:列1"
```

### GUI 工具测试

1. 配置服务器 → 点击"跳过列映射" → 选择文件夹 → 扫描 → 上传
2. 配置服务器 → 配置列映射 → 选择文件夹 → 扫描 → 转换 → 上传

## 注意事项

1. **CLI 工具**：虽然在不需要转换时 `--output` 参数会被忽略，但目前仍需要提供此参数（命令行解析要求）
2. **文件格式**：直接上传模式仍要求 Excel 文件格式符合服务器的导入要求
3. **列名要求**：使用直接上传模式时，Excel 文件的列名必须与服务器期望的列名完全匹配

## 后续优化建议

1. 修改 CLI 参数定义，使 `--output` 在不使用列映射时真正变为可选
2. 添加预检查功能，在上传前验证 Excel 文件的列名是否符合要求
3. 提供列名模板文件下载功能，帮助用户准备符合要求的 Excel 文件
